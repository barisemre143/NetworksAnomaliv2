{% extends "base.html" %}

{% block title %}{{ product.name }} - Ürün Detayı{% endblock %}

{% block content %}
<!-- Product Header -->
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">{{ product.name }}</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-6 mb-1">{{ product.name }}</h1>
                <p class="text-muted mb-0">
                    <span class="badge bg-primary">{{ product.brand }}</span>
                    <span class="badge bg-secondary">{{ product.category }}</span>
                    {% if product.subcategory %}
                    <span class="badge bg-info">{{ product.subcategory }}</span>
                    {% endif %}
                </p>
            </div>
            <div class="text-end">
                <h2 class="text-primary mb-0">{{ "₺{:,.2f}".format(product.our_price) }}</h2>
                <small class="text-muted">Mevcut fiyatımız</small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stat-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number">{{ history|length }}</div>
                    <div>Fiyat Kaydı</div>
                </div>
                <div class="display-4">
                    <i class="bi bi-graph-up"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stat-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number">{{ anomalies|length }}</div>
                    <div>Anomali</div>
                </div>
                <div class="display-4">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stat-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number">{{ product.our_stock or 0 }}</div>
                    <div>Stok</div>
                </div>
                <div class="display-4">
                    <i class="bi bi-box-seam"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number" id="competitorCount">-</div>
                    <div>Rekabetçi</div>
                </div>
                <div class="display-4">
                    <i class="bi bi-people"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row">
    <!-- Price Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i>
                        Fiyat Trendi
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="updateChart(7)">7G</button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="updateChart(30)">30G</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="updateChart(90)">90G</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="priceChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Advanced Analysis -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cpu"></i>
                    Gelişmiş Analiz
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="runFullAnalysis()">
                        <i class="bi bi-play-circle"></i> Tam Analiz Çalıştır
                    </button>
                    <button class="btn btn-outline-secondary" onclick="runTrendAnalysis()">
                        <i class="bi bi-graph-up"></i> Trend Analizi
                    </button>
                    <button class="btn btn-outline-info" onclick="runRiskAssessment()">
                        <i class="bi bi-shield-exclamation"></i> Risk Değerlendirmesi
                    </button>
                </div>
                
                <div id="analysisResults" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Price History & Anomalies -->
<div class="row">
    <!-- Recent Price History -->
    <div class="col-lg-7 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i>
                    Son Fiyat Değişiklikleri
                </h5>
            </div>
            <div class="card-body">
                {% if history %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Bizim Fiyat</th>
                                <th>Piyasa Ort.</th>
                                <th>Min-Max</th>
                                <th>Değişim</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in history[-10:] %}
                            <tr>
                                <td>{{ record.date.strftime('%d.%m.%Y') }}</td>
                                <td><strong>{{ "₺{:,.2f}".format(record.our_price) }}</strong></td>
                                <td>{{ "₺{:,.2f}".format(record.market_avg_price) }}</td>
                                <td>
                                    <small class="text-muted">
                                        {{ "₺{:,.0f}".format(record.market_min_price) }} - 
                                        {{ "₺{:,.0f}".format(record.market_max_price) }}
                                    </small>
                                </td>
                                <td>
                                    {% if loop.index > 1 %}
                                        {% set prev_price = history[loop.index0-1].our_price %}
                                        {% set change = ((record.our_price - prev_price) / prev_price * 100) %}
                                        {% if change > 0 %}
                                            <span class="text-success">+{{ "{:.1f}".format(change) }}%</span>
                                        {% elif change < 0 %}
                                            <span class="text-danger">{{ "{:.1f}".format(change) }}%</span>
                                        {% else %}
                                            <span class="text-muted">0%</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox display-1"></i>
                    <p>Henüz fiyat geçmişi yok</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Anomalies -->
    <div class="col-lg-5 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    Anomaliler
                </h5>
            </div>
            <div class="card-body">
                {% if anomalies %}
                <div class="list-group list-group-flush">
                    {% for anomaly in anomalies %}
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">
                                {{ anomaly.anomaly_type|title }}
                                <span class="badge anomaly-{{ anomaly.severity }} ms-2">
                                    {{ anomaly.severity|title }}
                                </span>
                            </div>
                            <p class="mb-1 small text-muted">
                                {{ "{:.1f}".format(anomaly.deviation_percent) }}% sapma
                            </p>
                            <small class="text-muted">
                                {{ anomaly.detected_at.strftime('%d.%m.%Y %H:%M') }}
                            </small>
                        </div>
                        {% if not anomaly.is_resolved %}
                        <button class="btn btn-outline-success btn-sm" 
                                onclick="resolveAnomaly({{ anomaly.id }})">
                            <i class="bi bi-check"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle display-1"></i>
                    <p>Anomali tespit edilmedi</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const productId = {{ product.id }};

// Initialize chart
document.addEventListener('DOMContentLoaded', function() {
    updateChart(30);
    loadCompetitorCount();
});

// Update price chart
async function updateChart(days) {
    try {
        const response = await fetch(`/api/product/${productId}/chart?days=${days}`);
        const chartData = await response.json();
        
        Plotly.newPlot('priceChart', chartData.data, chartData.layout, {responsive: true});
        
        // Update active button
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        event.target.classList.remove('btn-outline-primary');
        event.target.classList.add('btn-primary');
        
    } catch (error) {
        console.error('Error updating chart:', error);
        document.getElementById('priceChart').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Grafik yüklenirken hata oluştu: ${error.message}
            </div>
        `;
    }
}

// Load competitor count
async function loadCompetitorCount() {
    try {
        const response = await fetch(`/api/product/${productId}/chart?days=1`);
        const data = await response.json();
        
        if (data.data && data.data.length > 0) {
            // Get latest competitor count from chart data
            const competitorCount = 8; // Placeholder - should be extracted from data
            document.getElementById('competitorCount').textContent = competitorCount;
        }
    } catch (error) {
        console.error('Error loading competitor count:', error);
    }
}

// Run full analysis
async function runFullAnalysis() {
    const container = document.getElementById('analysisResults');
    showLoading(container);
    
    try {
        const analysis = await apiCall(`/api/product/${productId}/trend-analysis?days=90`);
        
        let html = '<div class="analysis-results">';
        html += '<h6 class="mb-3"><i class="bi bi-cpu"></i> Analiz Sonuçları</h6>';
        
        // ARIMA Results
        if (analysis.arima && !analysis.arima.error) {
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>ARIMA Tahmin</strong>
                        <span class="badge bg-primary">MAE: ₺${analysis.arima.mae.toFixed(2)}</span>
                    </div>
                    <div class="progress mb-2" style="height: 5px;">
                        <div class="progress-bar" style="width: ${Math.min(analysis.arima.mae/1000*100, 100)}%"></div>
                    </div>
                    <small class="text-muted">7 gün sonra: ₺${analysis.arima.forecast[6].toFixed(2)}</small>
                </div>
            `;
        }
        
        // LSTM Results
        if (analysis.lstm && !analysis.lstm.error) {
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>LSTM Tahmin</strong>
                        <span class="badge bg-success">RMSE: ₺${analysis.lstm.rmse.toFixed(2)}</span>
                    </div>
                    <div class="progress mb-2" style="height: 5px;">
                        <div class="progress-bar bg-success" style="width: ${Math.min(analysis.lstm.rmse/1000*100, 100)}%"></div>
                    </div>
                    <small class="text-muted">7 gün sonra: ₺${analysis.lstm.forecast[6].toFixed(2)}</small>
                </div>
            `;
        }
        
        // Risk Assessment
        if (analysis.risk_assessment) {
            const risk = analysis.risk_assessment;
            const riskColor = risk.risk_level === 'high' ? 'danger' : risk.risk_level === 'medium' ? 'warning' : 'success';
            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>Risk Seviyesi</strong>
                        <span class="badge bg-${riskColor}">${risk.risk_level.toUpperCase()}</span>
                    </div>
                    <small class="text-muted">Volatilite: ${formatPercent(risk.volatility)}</small>
                </div>
            `;
        }
        
        // Ensemble Forecast
        if (analysis.ensemble && analysis.ensemble.forecast) {
            html += `
                <div class="mb-3">
                    <div class="alert alert-info">
                        <strong><i class="bi bi-graph-up"></i> Ensemble Tahmin</strong><br>
                        <small>7 gün sonra: ₺${analysis.ensemble.forecast[6].toFixed(2)}</small>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Analiz çalıştırılırken hata oluştu: ${error.message}
            </div>
        `;
    }
}

// Run trend analysis
async function runTrendAnalysis() {
    const container = document.getElementById('analysisResults');
    showLoading(container);
    
    try {
        const analysis = await apiCall(`/api/product/${productId}/trend-analysis?days=30`);
        
        let html = '<div class="trend-analysis">';
        html += '<h6 class="mb-3"><i class="bi bi-graph-up"></i> Trend Analizi</h6>';
        
        if (analysis.decomposition) {
            const decomp = analysis.decomposition;
            html += `
                <div class="mb-3">
                    <div class="row">
                        <div class="col-6">
                            <strong>Trend Yönü</strong><br>
                            <span class="badge bg-info">${decomp.trend_direction}</span>
                        </div>
                        <div class="col-6">
                            <strong>Trend Gücü</strong><br>
                            <small>${(decomp.trend_strength * 100).toFixed(1)}%</small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (analysis.seasonality) {
            const seasonal = analysis.seasonality;
            html += `
                <div class="mb-3">
                    <strong>Sezonluk Analiz</strong><br>
                    <small class="text-muted">
                        ${seasonal.seasonality_detected ? 'Sezonluk tespit edildi' : 'Sezonluk yok'}<br>
                        En yüksek: ${seasonal.peak_day}<br>
                        En düşük: ${seasonal.valley_day}
                    </small>
                </div>
            `;
        }
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Trend analizi başarısız: ${error.message}
            </div>
        `;
    }
}

// Run risk assessment
async function runRiskAssessment() {
    const container = document.getElementById('analysisResults');
    showLoading(container);
    
    try {
        const analysis = await apiCall(`/api/product/${productId}/trend-analysis?days=60`);
        
        if (analysis.risk_assessment) {
            const risk = analysis.risk_assessment;
            const riskColor = risk.risk_level === 'high' ? 'danger' : risk.risk_level === 'medium' ? 'warning' : 'success';
            
            let html = `
                <div class="risk-assessment">
                    <h6 class="mb-3"><i class="bi bi-shield-exclamation"></i> Risk Değerlendirmesi</h6>
                    
                    <div class="alert alert-${riskColor}">
                        <strong>Risk Seviyesi: ${risk.risk_level.toUpperCase()}</strong>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Volatilite</strong><br>
                            <span class="text-muted">${formatPercent(risk.volatility)}</span>
                        </div>
                        <div class="col-6">
                            <strong>VaR (95%)</strong><br>
                            <span class="text-muted">${formatPercent(risk.var_95)}</span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>7 Gün Momentum</strong><br>
                            <span class="${risk.momentum_7d > 0 ? 'text-success' : 'text-danger'}">
                                ${formatPercent(risk.momentum_7d)}
                            </span>
                        </div>
                        <div class="col-6">
                            <strong>30 Gün Momentum</strong><br>
                            <span class="${risk.momentum_30d > 0 ? 'text-success' : 'text-danger'}">
                                ${formatPercent(risk.momentum_30d)}
                            </span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>30 Günlük Aralık</strong><br>
                        <small class="text-muted">
                            Min: ${formatCurrency(risk.price_range_30d.min)} | 
                            Max: ${formatCurrency(risk.price_range_30d.max)} | 
                            Ort: ${formatCurrency(risk.price_range_30d.mean)}
                        </small>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
    } catch (error) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Risk değerlendirmesi başarısız: ${error.message}
            </div>
        `;
    }
}

// Resolve anomaly
async function resolveAnomaly(anomaly_id) {
    try {
        const notes = prompt('Çözüm notu (opsiyonel):') || '';
        
        const response = await fetch(`/api/anomalies/resolve/${anomaly_id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ notes })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Anomali çözümlenirken hata oluştu');
        }
        
    } catch (error) {
        console.error('Error resolving anomaly:', error);
        alert('Anomali çözümlenirken hata oluştu');
    }
}
</script>
{% endblock %}