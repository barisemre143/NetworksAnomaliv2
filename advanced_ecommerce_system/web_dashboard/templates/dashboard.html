{% extends "base.html" %}

{% block title %}Dashboard - E-Ticaret Fiyat Analiz{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 mb-0">
            <i class="bi bi-speedometer2 text-primary"></i>
            Dashboard
        </h1>
        <p class="text-muted">Fiyat takibi ve analiz özeti</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4" data-auto-refresh="60000">
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number">{{ total_products }}</div>
                    <div>Aktif Ürün</div>
                </div>
                <div class="display-4">
                    <i class="bi bi-box-seam"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stat-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number">{{ total_anomalies }}</div>
                    <div>Açık Anomali</div>
                </div>
                <div class="display-4">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stat-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number" id="todayUpdates">-</div>
                    <div>Bugünkü Güncelleme</div>
                </div>
                <div class="display-4">
                    <i class="bi bi-arrow-repeat"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stat-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number" id="avgPrice">-</div>
                    <div>Ortalama Fiyat</div>
                </div>
                <div class="display-4">
                    <i class="bi bi-currency-exchange"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Row -->
<div class="row">
    <!-- Quick Analysis -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i>
                    Hızlı Analiz
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="productSelect" class="form-label">Ürün Seçin:</label>
                    <select class="form-select" id="productSelect" onchange="loadQuickAnalysis()">
                        <option value="">Bir ürün seçin...</option>
                        {% for product in products %}
                        <option value="{{ product.id }}">{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="quickAnalysisContainer">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-graph-up display-1"></i>
                        <p>Analiz için bir ürün seçin</p>
                    </div>
                </div>
                
                <!-- Akakçe Scraping Buttons -->
                <div class="mt-3" id="scrapingButtons" style="display: none;">
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-outline-success btn-sm" onclick="scrapeSelectedProduct()">
                            <i class="bi bi-cloud-download"></i> Seçili Ürünü Çek
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="checkScrapingStatus()">
                            <i class="bi bi-info-circle"></i> Durum
                        </button>
                    </div>
                </div>
                
                <!-- Bulk Scraping Button -->
                <div class="mt-3">
                    <button class="btn btn-success w-100" onclick="scrapeAllProducts()">
                        <i class="bi bi-cloud-download-fill"></i> Tüm Ürünler için Akakçe Scraping
                    </button>
                    <small class="text-muted d-block mt-1">
                        Tüm ürünlerin güncel piyasa fiyatlarını Akakçe'den çeker ve anomali tespiti yapar
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Anomalies -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    Son Anomaliler
                </h5>
            </div>
            <div class="card-body">
                {% if anomalies %}
                    <div class="list-group list-group-flush">
                        {% for anomaly_data in anomalies %}
                            {% set anomaly = anomaly_data[0] %}
                            {% set product_name = anomaly_data[1] %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ product_name }}</h6>
                                    <p class="mb-1 text-muted small">
                                        {{ anomaly.anomaly_type|title }} - 
                                        {{ "{:.1f}".format(anomaly.deviation_percent or 0) }}% fark
                                    </p>
                                    <small class="text-muted" data-timestamp="{{ anomaly.detected_at }}">
                                        {{ anomaly.detected_at.strftime('%d.%m.%Y %H:%M') }}
                                    </small>
                                </div>
                                <span class="badge anomaly-{{ anomaly.severity }}">
                                    {{ anomaly.severity|title }}
                                </span>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <a href="{{ url_for('anomalies') }}" class="btn btn-outline-primary btn-sm">
                            Tümünü Gör <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-check-circle display-1"></i>
                        <p>Henüz anomali yok</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Updates -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i>
                    Son Fiyat Güncellemeleri
                </h5>
            </div>
            <div class="card-body">
                {% if recent_updates %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Ürün</th>
                                    <th>Bizim Fiyat</th>
                                    <th>Piyasa Ort.</th>
                                    <th>Rekabet</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for update in recent_updates %}
                                <tr>
                                    <td data-timestamp="{{ update.date }}">
                                        {{ update.date.strftime('%d.%m.%Y') }}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('product_detail', product_id=update.product_id) }}" 
                                           class="text-decoration-none">
                                            Ürün #{{ update.product_id }}
                                        </a>
                                    </td>
                                    <td>
                                        <strong>₺{{ "{:,.2f}".format(update.our_price or 0) }}</strong>
                                    </td>
                                    <td>₺{{ "{:,.2f}".format(update.market_avg_price or 0) }}</td>
                                    <td>
                                        <span class="badge bg-info">
                                            {{ update.competitor_count }} satıcı
                                        </span>
                                    </td>
                                    <td>
                                        {% if update.our_price and update.market_avg_price and update.market_avg_price > 0 %}
                                            {% set ratio = update.our_price / update.market_avg_price %}
                                            {% if ratio > 1.1 %}
                                                <span class="badge bg-danger">Yüksek</span>
                                            {% elif ratio < 0.9 %}
                                                <span class="badge bg-warning">Düşük</span>
                                            {% else %}
                                                <span class="badge bg-success">Normal</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">Bilinmiyor</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-1"></i>
                        <p>Henüz güncelleme yok</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load dashboard stats
async function loadDashboardStats() {
    try {
        const stats = await apiCall('/api/dashboard-stats');
        
        document.getElementById('todayUpdates').textContent = stats.today_updates;
        document.getElementById('avgPrice').textContent = formatCurrency(stats.price_stats.avg);
        
    } catch (error) {
        console.error('Failed to load dashboard stats:', error);
    }
}

// Load quick analysis for selected product
async function loadQuickAnalysis() {
    const productId = document.getElementById('productSelect').value;
    const container = document.getElementById('quickAnalysisContainer');
    
    if (!productId) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-graph-up display-1"></i>
                <p>Analiz için bir ürün seçin</p>
            </div>
        `;
        return;
    }
    
    showLoading(container);
    
    try {
        // Load price chart
        const chartResponse = await fetch(`/api/product/${productId}/chart?days=7`);
        const chartData = await chartResponse.json();
        
        container.innerHTML = `
            <div id="quickChart" style="height: 300px;"></div>
            <div class="mt-3">
                <button class="btn btn-primary btn-sm" onclick="runTrendAnalysis(${productId})">
                    <i class="bi bi-cpu"></i> Trend Analizi Çalıştır
                </button>
            </div>
            <div id="trendResults" class="mt-3"></div>
        `;
        
        // Render chart
        Plotly.newPlot('quickChart', chartData.data, chartData.layout, {responsive: true});
        
    } catch (error) {
        container.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle display-1"></i>
                <p>Veri yüklenirken hata oluştu</p>
                <small>${error.message}</small>
            </div>
        `;
    }
}

// Run trend analysis
async function runTrendAnalysis(productId) {
    const resultsContainer = document.getElementById('trendResults');
    showLoading(resultsContainer);
    
    try {
        const analysis = await apiCall(`/api/product/${productId}/trend-analysis?days=30`);
        
        let html = '<div class="row">';
        
        // ARIMA results
        if (analysis.arima && !analysis.arima.error) {
            const forecast = analysis.arima.forecast;
            html += `
                <div class="col-md-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-graph-up"></i> ARIMA Tahmin</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>7 gün sonra:</strong></p>
                            <h4 class="text-primary">${formatCurrency(forecast[6])}</h4>
                            <small class="text-muted">MAE: ₺${analysis.arima.mae.toFixed(2)}</small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Risk assessment
        if (analysis.risk_assessment) {
            const risk = analysis.risk_assessment;
            const riskColor = risk.risk_level === 'high' ? 'danger' : risk.risk_level === 'medium' ? 'warning' : 'success';
            html += `
                <div class="col-md-4">
                    <div class="card border-${riskColor}">
                        <div class="card-header bg-${riskColor} text-white">
                            <h6 class="mb-0"><i class="bi bi-shield-exclamation"></i> Risk Analizi</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>Risk Seviyesi:</strong></p>
                            <h4 class="text-${riskColor}">${risk.risk_level.toUpperCase()}</h4>
                            <small class="text-muted">Volatilite: ${formatPercent(risk.volatility)}</small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Seasonality
        if (analysis.seasonality) {
            const seasonality = analysis.seasonality;
            html += `
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-calendar3"></i> Sezonluk</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>Sezonluk tespit:</strong></p>
                            <h4 class="text-info">${seasonality.seasonality_detected ? 'EVET' : 'HAYIR'}</h4>
                            <small class="text-muted">
                                En yüksek: ${seasonality.peak_day}<br>
                                En düşük: ${seasonality.valley_day}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        resultsContainer.innerHTML = html;
        
    } catch (error) {
        resultsContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Trend analizi çalıştırılırken hata oluştu: ${error.message}
            </div>
        `;
    }
}

// Scrape selected product from Akakçe
async function scrapeSelectedProduct() {
    const productId = document.getElementById('productSelect').value;
    
    if (!productId) {
        alert('Lütfen önce bir ürün seçin!');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    try {
        // Show loading state
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Çekiliyor...';
        button.disabled = true;
        
        const response = await fetch(`/api/scraping/akakce/single/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success notification
            showNotification('success', `✅ ${result.message}`, result.data);
            
            // Refresh quick analysis to show updated data
            loadQuickAnalysis();
        } else {
            showNotification('error', `❌ ${result.message}`);
        }
        
    } catch (error) {
        console.error('Scraping error:', error);
        showNotification('error', `❌ Scraping hatası: ${error.message}`);
    } finally {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Check scraping status
async function checkScrapingStatus() {
    try {
        const response = await fetch('/api/scraping/status');
        const status = await response.json();
        
        if (response.ok) {
            const statusHtml = `
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Scraping Durumu</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Toplam Akakçe Verisi:</small>
                                <div class="fw-bold">${status.total_akakce_data}</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Bugün Çekilen:</small>
                                <div class="fw-bold">${status.today_scraping}</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Son Çekme:</small>
                            <div class="fw-bold">
                                ${status.last_scraping ? new Date(status.last_scraping).toLocaleString('tr-TR') : 'Henüz yok'}
                            </div>
                        </div>
                        <div class="mt-2">
                            <span class="badge ${status.scraper_active ? 'bg-success' : 'bg-warning'}">
                                ${status.scraper_active ? 'Aktif' : 'Pasif'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            // Show status in a modal or alert
            showStatusModal('Scraping Durumu', statusHtml);
        } else {
            showNotification('error', `❌ Durum alınamadı: ${status.error}`);
        }
        
    } catch (error) {
        console.error('Status check error:', error);
        showNotification('error', `❌ Durum kontrolü hatası: ${error.message}`);
    }
}

// Show notification helper
function showNotification(type, message, data = null) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    
    let content = `
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <div>${message}</div>
    `;
    
    if (data && type === 'success') {
        content += `
            <hr>
            <small>
                <strong>Ürün:</strong> ${data.product_name}<br>
                <strong>Ortalama Fiyat:</strong> ₺${data.avg_price?.toFixed(2)}<br>
                <strong>Fiyat Aralığı:</strong> ₺${data.min_price?.toFixed(2)} - ₺${data.max_price?.toFixed(2)}<br>
                <strong>Satıcı Sayısı:</strong> ${data.price_count}<br>
                <strong>Bizim Fiyat:</strong> ₺${data.our_price?.toFixed(2)}<br>
                ${data.anomalies_detected > 0 ? `<span class="text-warning">⚠️ ${data.anomalies_detected} anomali tespit edildi</span>` : ''}
            </small>
        `;
    }
    
    notification.innerHTML = content;
    document.body.appendChild(notification);
    
    // Auto-remove after 8 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 8000);
}

// Show status modal helper
function showStatusModal(title, content) {
    // Remove existing modal if any
    const existingModal = document.getElementById('statusModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal
    const modal = document.createElement('div');
    modal.id = 'statusModal';
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up when hidden
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

// Scrape all products from Akakçe
async function scrapeAllProducts() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Confirm action
    if (!confirm('Tüm ürünler için Akakçe scraping başlatılsın mı? Bu işlem birkaç dakika sürebilir.')) {
        return;
    }
    
    try {
        // Show loading state
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Tüm ürünler çekiliyor...';
        button.disabled = true;
        
        const response = await fetch('/api/scraping/akakce/all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show detailed success notification
            const message = `✅ Toplu scraping tamamlandı!`;
            const data = {
                ...result.data,
                product_name: `${result.data.scraped_products} ürün işlendi`,
                avg_price: null,
                min_price: null,
                max_price: null,
                price_count: result.data.total_market_data || 0,
                our_price: null,
                anomalies_detected: result.data.anomalies_detected || 0
            };
            showNotification('success', message, data);
            
            // Refresh dashboard stats
            loadDashboardStats();
            
            // Refresh quick analysis if a product is selected
            if (document.getElementById('productSelect').value) {
                loadQuickAnalysis();
            }
        } else {
            showNotification('error', `❌ ${result.message}`);
        }
        
    } catch (error) {
        console.error('Bulk scraping error:', error);
        showNotification('error', `❌ Toplu scraping hatası: ${error.message}`);
    } finally {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Update loadQuickAnalysis to show scraping buttons when product is selected
const originalLoadQuickAnalysis = loadQuickAnalysis;
loadQuickAnalysis = function() {
    const productId = document.getElementById('productSelect').value;
    const scrapingButtons = document.getElementById('scrapingButtons');
    
    // Show/hide scraping buttons based on product selection
    if (productId) {
        scrapingButtons.style.display = 'block';
    } else {
        scrapingButtons.style.display = 'none';
    }
    
    // Call original function
    return originalLoadQuickAnalysis.call(this);
};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    
    // Auto-refresh stats every minute
    setInterval(loadDashboardStats, 60000);
});
</script>
{% endblock %}